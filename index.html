<!DOCTYPE html>
<html lang="en">
<head>

  <script src='//libtl.com/sdk.js' data-zone='9771118' data-sdk='show_9771118'></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money Tree</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #FFD700; --secondary-color: #4CAF50; --danger-color: #FF6347; --info-color: #2196F3; --success-color: #00e676; --background-color: #121212; --surface-color: #1e1e1e; --text-color: #ffffff; }
        body { margin: 0; padding: 20px; background: var(--background-color); color: var(--text-color); font-family: 'Poppins', Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container { text-align: center; background: var(--surface-color); padding: 25px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); width: 100%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1); }
        h1 { font-size: 24px; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; }
        .user-info { margin-bottom: 20px; font-size: 14px; color: #ccc; }
        .stats { display: flex; justify-content: space-around; margin: 20px 0; gap: 15px; }
        .stat-item { background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; flex-grow: 1; }
        .stats p { margin: 0; font-size: 12px; color: #ccc; text-transform: uppercase; }
        .stats span { font-size: 20px; font-weight: 600; color: var(--primary-color); }
        .progress-circle { width: 100px; height: 100px; border-radius: 50%; display: grid; place-items: center; margin: 20px auto; background: conic-gradient(var(--primary-color) 0deg, #333 0deg); position: relative; }
        .progress-circle::before { content: ""; position: absolute; width: 80px; height: 80px; background: var(--surface-color); border-radius: 50%; }
        .progress-circle span { font-size: 22px; font-weight: 600; color: var(--primary-color); position: relative; }
        .buttons { display: flex; flex-direction: column; gap: 10px; }
        .buttons button { width: 100%; padding: 12px; font-size: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; gap: 8px; -webkit-tap-highlight-color: transparent; }
        #watch-ad-btn { background: var(--primary-color); color: #000; }
        #claim-bonus-btn { background: var(--success-color); color: #000; }
        #referral-btn { background: var(--info-color); color: white; }
        .withdraw-btn { background: linear-gradient(45deg, #e6b400, #a88502); color: white; margin-top: 5px; }
        .toggle-section { margin-top: 25px; display: none; padding: 20px; background-color: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left; }
        .toggle-section h3 { color: var(--primary-color); text-align: center; margin-top: 0; margin-bottom: 20px; }
        .toggle-section input, .toggle-section select, .toggle-section button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background-color: #333; color: white; font-family: 'Poppins', sans-serif; box-sizing: border-box; }
        .toggle-section button { background-color: var(--secondary-color); border: none; cursor: pointer; font-weight: 600; }
        #referral-link { background-color: #222; padding: 10px; border-radius: 5px; word-wrap: break-word; cursor: pointer; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; color: var(--primary-color); font-size: 18px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay"><p>Loading User Data...</p></div>
    <div class="container" style="display: none;">
        <h1>Money Tree</h1>
        <div class="user-info"><p>Welcome, <span id="user-name">Guest</span></p></div>
        <div class="stats">
            <div class="stat-item"><p>Watched Ads</p><span id="watched-ads">0</span></div>
            <div class="stat-item"><p>Earned Points</p><span id="earned-points">0.00</span></div>
        </div>
        <div class="progress-circle" id="progress-circle-container"><span id="ads-progress">0%</span></div>
        <div class="buttons">
            <button id="watch-ad-btn" onclick="watchAd()">Watch Ad</button>
            <button id="claim-bonus-btn" onclick="claimReferralBonus()">üéÅ Claim Referral Bonus (<span id="unclaimed-referrals">0</span>)</button>
            <button id="referral-btn" onclick="showReferralSection()">üíå Invite & Earn</button>
            <button class="withdraw-btn" onclick="showWithdrawForm()">Withdrawal Request</button>
        </div>
        <div id="referral-section" class="toggle-section">
            <h3>Your Referral Link</h3>
            <p>Invite friends and earn 5 points for each new user!</p>
            <div id="referral-link-container"><p id="referral-link" onclick="copyReferralLink()">Click to copy</p><span id="copy-status"></span></div>
        </div>
        <div id="withdraw-section" class="toggle-section">
            <h3>Withdrawal</h3>
            <input type="number" id="withdraw-amount" placeholder="Enter points to withdraw" min="5">
            <select id="payment-method" onchange="updateWithdrawPlaceholder()"><option value="Bkash">Bkash</option><option value="Binance ID">Binance ID</option></select>
            <input type="text" id="withdraw-details" placeholder="Enter phone number">
            <button onclick="requestWithdrawal()">Submit Request</button>
            <p id="withdraw-status"></p>
        </div>
    </div>
    <script>
        (function(){ const adScript = document.createElement('script'); adScript.async = true; adScript.src = 'https://' + ['js','onclckmn','com'].join('.') + '/static/onclicka.js'; adScript.setAttribute('data-admpid', '310679'); document.head.appendChild(adScript); })();
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script>
        // ===================================================================
        // ****** ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ******
        // ===================================================================

        const firebaseConfig = {
            // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ firebaseConfig ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional

  apiKey: "AIzaSyANkFuPPFthsfrWNPwy6_vnFNhPJkPI5ew",
  authDomain: "money-tree-bot.firebaseapp.com",
  projectId: "money-tree-bot",
  storageBucket: "money-tree-bot.firebasestorage.app",
  messagingSenderId: "493331421972",
  appId: "1:493331421972:web:28227bfb312680c7c84001",
  measurementId: "G-38NSJXXG66"
};

        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡¶ü ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        const BOT_TOKEN = "7633393855:AAFeu07OuhX5l5bdcqgvP-chsF7E2zCtHbU"; 

        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        const ADMIN_USER_ID = "5146589219";

        // ===================================================================
        // ****** ‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶Ç‡¶∂ ******
        // ===================================================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let userDocRef = null;
        let currentUserId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const userName = urlParams.get('userName') || 'Guest';
            const referrerId = urlParams.get('ref');

            if (!userId) {
                document.getElementById('loading-overlay').innerHTML = '<p style="color:red;padding:10px;">Error: Invalid user link. Please open from your Telegram bot.</p>';
                return;
            }
            currentUserId = userId;

            auth.signInAnonymously().then(() => {
                userDocRef = db.collection('users').doc(userId);
                userDocRef.onSnapshot(async (doc) => {
                    if (!doc.exists) {
                        const newUser = { name: userName, watchedAds: 0, earnedPoints: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                        await userDocRef.set(newUser);
                        if (referrerId && referrerId !== userId) {
                            await db.collection('referrals').doc(userId).set({
                                referrer: referrerId,
                                refereeName: userName,
                                claimed: false,
                                joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    } else {
                        updateUI(doc.data());
                    }
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                });
                
                db.collection('referrals').where('referrer', '==', userId).where('claimed', '==', false)
                  .onSnapshot(snapshot => {
                      document.getElementById('unclaimed-referrals').textContent = snapshot.size;
                  });

            }).catch(error => {
                console.error("Auth/DB Error:", error);
                document.getElementById('loading-overlay').innerText = 'Error: Could not connect.';
            });
        });

        function updateUI(data) {
            document.getElementById('user-name').textContent = data.name || 'Guest';
            document.getElementById('watched-ads').textContent = data.watchedAds || 0;
            document.getElementById('earned-points').textContent = (data.earnedPoints || 0).toFixed(2);
            const percentage = Math.min(((data.watchedAds || 0) / 10) * 100, 100);
            const degree = (percentage / 100) * 360;
            document.getElementById('ads-progress').textContent = `${Math.floor(percentage)}%`;
            document.getElementById('progress-circle-container').style.background = `conic-gradient(var(--primary-color) ${degree}deg, #333 ${degree}deg)`;
        }

        function watchAd() {
            if (typeof show_9771118 === 'function') {
                show_9771118().then(() => {
                    const increment = firebase.firestore.FieldValue.increment;
                    userDocRef.update({ watchedAds: increment(1), earnedPoints: increment(0.50) }).catch(err => console.error("Error:", err));
                });
            }
        }
        
        async function claimReferralBonus() {
            const claimButton = document.getElementById('claim-bonus-btn');
            claimButton.disabled = true;
            claimButton.textContent = 'Claiming...';

            const querySnapshot = await db.collection('referrals')
                .where('referrer', '==', currentUserId)
                .where('claimed', '==', false)
                .get();
            
            if (querySnapshot.empty) {
                alert("You have no new referral bonuses to claim.");
                claimButton.disabled = false;
                claimButton.innerHTML = 'üéÅ Claim Referral Bonus (<span id="unclaimed-referrals">0</span>)';
                return;
            }

            const batch = db.batch();
            const bonusPoints = querySnapshot.size * 5;

            querySnapshot.forEach(doc => {
                const ref = db.collection('referrals').doc(doc.id);
                batch.update(ref, { claimed: true });
            });
            
            const increment = firebase.firestore.FieldValue.increment;
            batch.update(userDocRef, { earnedPoints: increment(bonusPoints) });

            try {
                await batch.commit();
                alert(`Congratulations! You have claimed ${bonusPoints} points from ${querySnapshot.size} new referrals.`);
            } catch (error) {
                console.error("Error claiming bonus: ", error);
                alert("Something went wrong. Please try again.");
            } finally {
                claimButton.disabled = false;
                claimButton.innerHTML = `üéÅ Claim Referral Bonus (<span id="unclaimed-referrals">${document.getElementById('unclaimed-referrals').textContent}</span>)`;
            }
        }

        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('payment-method').value;
            const details = document.getElementById('withdraw-details').value;
            const statusEl = document.getElementById('withdraw-status');
            
            if (!amount || amount < 5 || !details) {
                statusEl.textContent = 'Please fill all fields correctly.'; return;
            }
            
            statusEl.textContent = 'Submitting...';
            const userData = (await userDocRef.get()).data();
            
            if (userData.earnedPoints < amount) {
                statusEl.textContent = 'Insufficient balance.'; return;
            }
            
            try {
                await db.collection('withdrawals').add({
                    userId: userDocRef.id,
                    userName: userData.name,
                    amount: amount,
                    method: method,
                    details: details,
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                const msg = `üü° *New Withdraw Request* üü°\n\nUser: ${userData.name} (\`${userDocRef.id}\`)\nPoints: *${amount}*\nMethod: ${method}\nDetails: \`${details}\`\n\n*Action Required: Please review and process this request from the Firebase console.*`;
                sendTelegram(msg);

                statusEl.textContent = '‚úÖ Request submitted for review!';
                document.getElementById('withdraw-amount').value = '';
                document.getElementById('withdraw-details').value = '';
            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                statusEl.textContent = 'An error occurred. Please try again.';
            }
        }

        function sendTelegram(message) {
            if (!BOT_TOKEN || !ADMIN_USER_ID) {
                console.warn("Telegram BOT_TOKEN or ADMIN_USER_ID is not set.");
                return;
            }
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_id: ADMIN_USER_ID,
                    text: message,
                    parse_mode: "Markdown"
                })
            }).catch(error => console.error("Telegram sending error:", error));
        }

        function hideAllSections() { document.querySelectorAll('.toggle-section').forEach(el => el.style.display = 'none'); }
        function showWithdrawForm() { hideAllSections(); document.getElementById('withdraw-section').style.display = 'block'; updateWithdrawPlaceholder(); }
        function showReferralSection() { hideAllSections(); const link = `${window.location.origin}${window.location.pathname}?ref=${currentUserId}`; document.getElementById('referral-link').textContent = link; document.getElementById('referral-section').style.display = 'block'; }
        function updateWithdrawPlaceholder() { document.getElementById('withdraw-details').placeholder = (document.getElementById('payment-method').value === 'Binance ID') ? 'Enter Binance ID' : 'Enter phone number'; }
        function copyReferralLink() { navigator.clipboard.writeText(document.getElementById('referral-link').textContent).then(() => { const s = document.getElementById('copy-status'); s.textContent = 'Copied!'; setTimeout(() => { s.textContent = ''; }, 2000); }); }
    </script>
</body>
</html>
